<!--
 * Copyright (c) 2009 The Chromium Authors. All rights reserved.  Use of this
 * source code is governed by a BSD-style license that can be found in the
 * LICENSE file.
-->
<html>
<head>
<script type="text/javascript" src="common.js"></script>
<script>
  // A dictionary keyed off of tabId that keeps track of data per tab (for
  // example what feedUrl was detected in the tab).
  var feedData = {};

  chrome.extension.onRequest.addListener(
    function(request, sender) {
      if (request.msg == "feedIcon") {
        // We have received a list of feed urls found on the page.
        // Enable the page action icon.
        feedData[sender.tab.id] = request.feeds;
        chrome.pageAction.setTitle({ tabId: sender.tab.id,
          title: "Click to subscribe..."
        });
        chrome.pageAction.show(sender.tab.id);
      }
      if (request.msg == "feedView") {
        var tab = sender.tab;
        if (!tab) return;
        var feed_url = request.url;

        // See if we need to skip the preview page and subscribe directly.
        var url = "";
        if (window.localStorage && window.localStorage.showPreviewPage == "No") {
          // Skip the preview.
          url = getReaderWithUrl(window.localStorage.defaultReader, feed_url);
        } else {
          // Show the preview page.
          url = "subscribe.html?" + encodeURIComponent(feed_url);
        }

        chrome.tabs.update(tab.id,{url:url});
      }
    });

  chrome.tabs.onRemoved.addListener(function(tabId) {
    delete feedData[tabId];
  });
</script>
</head>
</html>
