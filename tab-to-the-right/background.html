<script>
var selIndex;
var maxIndex;

chrome.tabs.onCreated.addListener(function(tab) {
  var myIndex = tab.index;
  chrome.tabs.getAllInWindow(null, function(tabs) {
    maxIndex = tabs.length - 1;
    if (myIndex == maxIndex)
      chrome.tabs.move(tab.id, {
        index: selIndex + 1
      });
  });
});

chrome.tabs.onSelectionChanged.addListener(function(tabId, _) {
  chrome.tabs.get(tabId, function(tab) {
    selIndex = tab.index;
  });
});

chrome.tabs.onMoved.addListener(function(_, moveInfo) {
  selIndex = moveInfo.toIndex;
});

function updateSel() {
  chrome.tabs.getSelected(null, function(tab) {
    selIndex = tab.index;
  });
}

chrome.tabs.onRemoved.addListener(function(_) {
  updateSel();
});

chrome.tabs.onAttached.addListener(function(_, _) {
  updateSel();
});

chrome.windows.onFocusChanged.addListener(function(_) {
  updateSel();
});

</script>
